<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>/**<a name="line.1"></a>
<span class="sourceLineNo">002</span> * Copyright 2014 Tampere University of Technology, Pori Unit<a name="line.2"></a>
<span class="sourceLineNo">003</span> * <a name="line.3"></a>
<span class="sourceLineNo">004</span> * Licensed under the Apache License, Version 2.0 (the "License");<a name="line.4"></a>
<span class="sourceLineNo">005</span> * you may not use this file except in compliance with the License.<a name="line.5"></a>
<span class="sourceLineNo">006</span> * You may obtain a copy of the License at<a name="line.6"></a>
<span class="sourceLineNo">007</span> * <a name="line.7"></a>
<span class="sourceLineNo">008</span> *   http://www.apache.org/licenses/LICENSE-2.0<a name="line.8"></a>
<span class="sourceLineNo">009</span> * <a name="line.9"></a>
<span class="sourceLineNo">010</span> * Unless required by applicable law or agreed to in writing, software<a name="line.10"></a>
<span class="sourceLineNo">011</span> * distributed under the License is distributed on an "AS IS" BASIS,<a name="line.11"></a>
<span class="sourceLineNo">012</span> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<a name="line.12"></a>
<span class="sourceLineNo">013</span> * See the License for the specific language governing permissions and<a name="line.13"></a>
<span class="sourceLineNo">014</span> * limitations under the License.<a name="line.14"></a>
<span class="sourceLineNo">015</span> */<a name="line.15"></a>
<span class="sourceLineNo">016</span>package service.tut.pori.contentanalysis;<a name="line.16"></a>
<span class="sourceLineNo">017</span><a name="line.17"></a>
<span class="sourceLineNo">018</span>import java.util.ArrayList;<a name="line.18"></a>
<span class="sourceLineNo">019</span>import java.util.Collection;<a name="line.19"></a>
<span class="sourceLineNo">020</span>import java.util.Date;<a name="line.20"></a>
<span class="sourceLineNo">021</span>import java.util.EnumSet;<a name="line.21"></a>
<span class="sourceLineNo">022</span>import java.util.HashMap;<a name="line.22"></a>
<span class="sourceLineNo">023</span>import java.util.HashSet;<a name="line.23"></a>
<span class="sourceLineNo">024</span>import java.util.Iterator;<a name="line.24"></a>
<span class="sourceLineNo">025</span>import java.util.List;<a name="line.25"></a>
<span class="sourceLineNo">026</span>import java.util.Map;<a name="line.26"></a>
<span class="sourceLineNo">027</span>import java.util.Map.Entry;<a name="line.27"></a>
<span class="sourceLineNo">028</span>import java.util.Set;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import java.util.UUID;<a name="line.29"></a>
<span class="sourceLineNo">030</span><a name="line.30"></a>
<span class="sourceLineNo">031</span>import org.apache.commons.lang3.ArrayUtils;<a name="line.31"></a>
<span class="sourceLineNo">032</span>import org.apache.commons.lang3.StringUtils;<a name="line.32"></a>
<span class="sourceLineNo">033</span>import org.apache.log4j.Logger;<a name="line.33"></a>
<span class="sourceLineNo">034</span>import org.apache.solr.client.solrj.response.QueryResponse;<a name="line.34"></a>
<span class="sourceLineNo">035</span>import org.apache.solr.client.solrj.response.UpdateResponse;<a name="line.35"></a>
<span class="sourceLineNo">036</span>import org.apache.solr.common.SolrException;<a name="line.36"></a>
<span class="sourceLineNo">037</span>import org.springframework.beans.factory.annotation.Autowired;<a name="line.37"></a>
<span class="sourceLineNo">038</span><a name="line.38"></a>
<span class="sourceLineNo">039</span>import service.tut.pori.contentanalysis.CAContentCore.ServiceType;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import service.tut.pori.contentanalysis.CAContentCore.Visibility;<a name="line.40"></a>
<span class="sourceLineNo">041</span>import service.tut.pori.contentanalysis.MediaObject.ConfirmationStatus;<a name="line.41"></a>
<span class="sourceLineNo">042</span>import service.tut.pori.contentanalysis.MediaObject.MediaObjectType;<a name="line.42"></a>
<span class="sourceLineNo">043</span>import core.tut.pori.dao.SimpleSolrTemplate;<a name="line.43"></a>
<span class="sourceLineNo">044</span>import core.tut.pori.dao.SolrDAO;<a name="line.44"></a>
<span class="sourceLineNo">045</span>import core.tut.pori.dao.SolrQueryBuilder;<a name="line.45"></a>
<span class="sourceLineNo">046</span>import core.tut.pori.dao.SQLSelectBuilder.OrderDirection;<a name="line.46"></a>
<span class="sourceLineNo">047</span>import core.tut.pori.dao.filter.AbstractQueryFilter;<a name="line.47"></a>
<span class="sourceLineNo">048</span>import core.tut.pori.dao.filter.AndQueryFilter;<a name="line.48"></a>
<span class="sourceLineNo">049</span>import core.tut.pori.dao.filter.AndSubQueryFilter;<a name="line.49"></a>
<span class="sourceLineNo">050</span>import core.tut.pori.dao.filter.OrQueryFilter;<a name="line.50"></a>
<span class="sourceLineNo">051</span>import core.tut.pori.dao.filter.OrSubQueryFilter;<a name="line.51"></a>
<span class="sourceLineNo">052</span>import core.tut.pori.dao.filter.RangeQueryFilter;<a name="line.52"></a>
<span class="sourceLineNo">053</span>import core.tut.pori.http.parameters.DataGroups;<a name="line.53"></a>
<span class="sourceLineNo">054</span>import core.tut.pori.http.parameters.Limits;<a name="line.54"></a>
<span class="sourceLineNo">055</span>import core.tut.pori.http.parameters.QueryParameter;<a name="line.55"></a>
<span class="sourceLineNo">056</span>import core.tut.pori.http.parameters.SortOptions;<a name="line.56"></a>
<span class="sourceLineNo">057</span>import core.tut.pori.http.parameters.SortOptions.Option;<a name="line.57"></a>
<span class="sourceLineNo">058</span>import core.tut.pori.users.UserIdentity;<a name="line.58"></a>
<span class="sourceLineNo">059</span>import core.tut.pori.utils.MediaUrlValidator.MediaType;<a name="line.59"></a>
<span class="sourceLineNo">060</span><a name="line.60"></a>
<span class="sourceLineNo">061</span><a name="line.61"></a>
<span class="sourceLineNo">062</span>/**<a name="line.62"></a>
<span class="sourceLineNo">063</span> * The DAO for storing and retrieving media objects.<a name="line.63"></a>
<span class="sourceLineNo">064</span> * <a name="line.64"></a>
<span class="sourceLineNo">065</span> * This class can also be used to retrieve media object suggestions. Note that if you wish to associate media objects with photos you must use PhotoDAO, not this class.<a name="line.65"></a>
<span class="sourceLineNo">066</span> *<a name="line.66"></a>
<span class="sourceLineNo">067</span> */<a name="line.67"></a>
<span class="sourceLineNo">068</span>public class MediaObjectDAO extends SolrDAO{<a name="line.68"></a>
<span class="sourceLineNo">069</span>  /** Default media object type for search operations, when object type is not specified */<a name="line.69"></a>
<span class="sourceLineNo">070</span>  public static final MediaObjectType DEFAULT_MEDIA_OBJECT_TYPE = MediaObjectType.KEYWORD;<a name="line.70"></a>
<span class="sourceLineNo">071</span>  private static final String BEAN_ID_SOLR_SERVER = "solrServerMediaObjects";<a name="line.71"></a>
<span class="sourceLineNo">072</span>  private static final int[] DEFAULT_CONFIRMATION_STATUS_LIST = ConfirmationStatus.toIntArray(EnumSet.of(ConfirmationStatus.CANDIDATE, ConfirmationStatus.USER_CONFIRMED));<a name="line.72"></a>
<span class="sourceLineNo">073</span>  private static final SortOptions DEFAULT_SORT_OPTIONS;<a name="line.73"></a>
<span class="sourceLineNo">074</span>  static{<a name="line.74"></a>
<span class="sourceLineNo">075</span>    DEFAULT_SORT_OPTIONS = new SortOptions();<a name="line.75"></a>
<span class="sourceLineNo">076</span>    DEFAULT_SORT_OPTIONS.addSortOption(new SortOptions.Option(SOLR_FIELD_ID, OrderDirection.ASCENDING, Definitions.ELEMENT_MEDIA_OBJECTLIST));<a name="line.76"></a>
<span class="sourceLineNo">077</span>  }<a name="line.77"></a>
<span class="sourceLineNo">078</span>  private static final Visibility DEFAULT_VISIBILITY = Visibility.PRIVATE;<a name="line.78"></a>
<span class="sourceLineNo">079</span>  private static final String[] FIELDS_DATA_GROUP_DEFAULTS = new String[]{<a name="line.79"></a>
<span class="sourceLineNo">080</span>    Definitions.SOLR_FIELD_BACKEND_ID, Definitions.SOLR_FIELD_CONFIDENCE, SOLR_FIELD_ID, Definitions.SOLR_FIELD_NAME, Definitions.SOLR_FIELD_CREATOR_OBJECT_ID, Definitions.SOLR_FIELD_RANK, Definitions.SOLR_FIELD_UPDATED, Definitions.SOLR_FIELD_VALUE, // members<a name="line.80"></a>
<span class="sourceLineNo">081</span>    Definitions.SOLR_FIELD_USER_ID, // user identity<a name="line.81"></a>
<span class="sourceLineNo">082</span>    Definitions.SOLR_FIELD_SERVICE_ID, // service type<a name="line.82"></a>
<span class="sourceLineNo">083</span>    Definitions.SOLR_FIELD_MEDIA_OBJECT_TYPE, // object type<a name="line.83"></a>
<span class="sourceLineNo">084</span>    Definitions.SOLR_FIELD_MEDIA_TYPE, // media type<a name="line.84"></a>
<span class="sourceLineNo">085</span>    Definitions.SOLR_FIELD_VISUAL_SHAPE_VALUE, // for visual shape<a name="line.85"></a>
<span class="sourceLineNo">086</span>    Definitions.SOLR_FIELD_VISUAL_SHAPE_TYPE,  // for visual shape<a name="line.86"></a>
<span class="sourceLineNo">087</span>    Definitions.SOLR_FIELD_STATUS // confirmation status<a name="line.87"></a>
<span class="sourceLineNo">088</span>    };<a name="line.88"></a>
<span class="sourceLineNo">089</span>  private static final String[] FIELDS_DATA_GROUP_TIMECODES = new String[]{Definitions.SOLR_FIELD_TIMECODES};<a name="line.89"></a>
<span class="sourceLineNo">090</span>  private static final String[] FIELDS_RESOLVE_OBJECT_IDS = new String[]{SOLR_FIELD_ID, Definitions.SOLR_FIELD_BACKEND_ID, Definitions.SOLR_FIELD_USER_ID, Definitions.SOLR_FIELD_CREATOR_OBJECT_ID};<a name="line.90"></a>
<span class="sourceLineNo">091</span>  private static final String[] FIELDS_UPDATE = new String[]{Definitions.SOLR_FIELD_USER_ID, SOLR_FIELD_ID, Definitions.SOLR_FIELD_BACKEND_ID, Definitions.SOLR_FIELD_CREATOR_OBJECT_ID};<a name="line.91"></a>
<span class="sourceLineNo">092</span>  private static final Logger LOGGER = Logger.getLogger(MediaObjectDAO.class);<a name="line.92"></a>
<span class="sourceLineNo">093</span>  @Autowired<a name="line.93"></a>
<span class="sourceLineNo">094</span>  private KeywordsDAO _keywordsDAO = null;<a name="line.94"></a>
<span class="sourceLineNo">095</span>  @Autowired<a name="line.95"></a>
<span class="sourceLineNo">096</span>  private PhotoDAO _photoDAO = null;<a name="line.96"></a>
<span class="sourceLineNo">097</span>  <a name="line.97"></a>
<span class="sourceLineNo">098</span>  /**<a name="line.98"></a>
<span class="sourceLineNo">099</span>   * @param objects<a name="line.99"></a>
<span class="sourceLineNo">100</span>   * @return true on success<a name="line.100"></a>
<span class="sourceLineNo">101</span>   */<a name="line.101"></a>
<span class="sourceLineNo">102</span>  public boolean insert(MediaObjectList objects){<a name="line.102"></a>
<span class="sourceLineNo">103</span>    if(MediaObjectList.isEmpty(objects)){<a name="line.103"></a>
<span class="sourceLineNo">104</span>      LOGGER.debug("Ignored empty object list.");<a name="line.104"></a>
<span class="sourceLineNo">105</span>      return true;<a name="line.105"></a>
<span class="sourceLineNo">106</span>    }<a name="line.106"></a>
<span class="sourceLineNo">107</span>    Date updated = new Date();<a name="line.107"></a>
<span class="sourceLineNo">108</span>    List&lt;MediaObject&gt; v = objects.getMediaObjects();<a name="line.108"></a>
<span class="sourceLineNo">109</span>    for(Iterator&lt;MediaObject&gt; vIter = v.iterator(); vIter.hasNext();){  // make sure all objects has updated timestamps<a name="line.109"></a>
<span class="sourceLineNo">110</span>      MediaObject o = vIter.next();<a name="line.110"></a>
<span class="sourceLineNo">111</span>      if(o.getUpdated() == null){<a name="line.111"></a>
<span class="sourceLineNo">112</span>        o.setUpdated(updated);<a name="line.112"></a>
<span class="sourceLineNo">113</span>      }<a name="line.113"></a>
<span class="sourceLineNo">114</span>      if(o.getMediaObjectId() != null){<a name="line.114"></a>
<span class="sourceLineNo">115</span>        LOGGER.warn("Replacing Media object Id exist for media object with existing id, id: "+o.getMediaObjectId());<a name="line.115"></a>
<span class="sourceLineNo">116</span>      }<a name="line.116"></a>
<span class="sourceLineNo">117</span>      String mediaObjectId = UUID.randomUUID().toString();<a name="line.117"></a>
<span class="sourceLineNo">118</span>      o.setMediaObjectId(mediaObjectId);<a name="line.118"></a>
<span class="sourceLineNo">119</span>      if(o.getObjectId() == null){<a name="line.119"></a>
<span class="sourceLineNo">120</span>        LOGGER.debug("No objectId given, using media object id.");<a name="line.120"></a>
<span class="sourceLineNo">121</span>        o.setObjectId(mediaObjectId);<a name="line.121"></a>
<span class="sourceLineNo">122</span>      }<a name="line.122"></a>
<span class="sourceLineNo">123</span>      if(o.getOwnerUserId() == null){<a name="line.123"></a>
<span class="sourceLineNo">124</span>        LOGGER.debug("Adding media object without owner.");<a name="line.124"></a>
<span class="sourceLineNo">125</span>      }<a name="line.125"></a>
<span class="sourceLineNo">126</span>      if(o.getVisibility() == null){<a name="line.126"></a>
<span class="sourceLineNo">127</span>        LOGGER.debug("No visibility value given, using default: "+DEFAULT_VISIBILITY.name());<a name="line.127"></a>
<span class="sourceLineNo">128</span>        o.setVisibility(DEFAULT_VISIBILITY);<a name="line.128"></a>
<span class="sourceLineNo">129</span>      }<a name="line.129"></a>
<span class="sourceLineNo">130</span>    }<a name="line.130"></a>
<span class="sourceLineNo">131</span>    if(!MediaObjectList.isValid(objects)){  // check validity after ids have been generated<a name="line.131"></a>
<span class="sourceLineNo">132</span>      LOGGER.warn("Tried to add invalid object list.");<a name="line.132"></a>
<span class="sourceLineNo">133</span>      return false;<a name="line.133"></a>
<span class="sourceLineNo">134</span>    }<a name="line.134"></a>
<span class="sourceLineNo">135</span>    SimpleSolrTemplate template = getSolrTemplate(BEAN_ID_SOLR_SERVER); <a name="line.135"></a>
<span class="sourceLineNo">136</span>    UpdateResponse response = template.addBeans(v); <a name="line.136"></a>
<span class="sourceLineNo">137</span>    if(response.getStatus() == SolrException.ErrorCode.UNKNOWN.code){<a name="line.137"></a>
<span class="sourceLineNo">138</span>      return true;<a name="line.138"></a>
<span class="sourceLineNo">139</span>    }else{<a name="line.139"></a>
<span class="sourceLineNo">140</span>      LOGGER.warn("Failed to add media objects.");<a name="line.140"></a>
<span class="sourceLineNo">141</span>      return false;<a name="line.141"></a>
<span class="sourceLineNo">142</span>    }<a name="line.142"></a>
<span class="sourceLineNo">143</span>  }<a name="line.143"></a>
<span class="sourceLineNo">144</span>  <a name="line.144"></a>
<span class="sourceLineNo">145</span>  /**<a name="line.145"></a>
<span class="sourceLineNo">146</span>   * helper methods for resolving object ids (backendId, mediaObjectId, objectId, userId)<a name="line.146"></a>
<span class="sourceLineNo">147</span>   * <a name="line.147"></a>
<span class="sourceLineNo">148</span>   * @param backendIdObjectIdMap<a name="line.148"></a>
<span class="sourceLineNo">149</span>   * @param mediaObjectIds<a name="line.149"></a>
<span class="sourceLineNo">150</span>   * @param objects<a name="line.150"></a>
<span class="sourceLineNo">151</span>   */<a name="line.151"></a>
<span class="sourceLineNo">152</span>  private void resolveObjectIds(Map&lt;Integer, HashSet&lt;String&gt;&gt; backendIdObjectIdMap, Set&lt;String&gt; mediaObjectIds, List&lt;MediaObject&gt; objects){<a name="line.152"></a>
<span class="sourceLineNo">153</span>    boolean noMediaObjectIds = mediaObjectIds.isEmpty();<a name="line.153"></a>
<span class="sourceLineNo">154</span>    boolean noObjectIds = backendIdObjectIdMap.isEmpty();<a name="line.154"></a>
<span class="sourceLineNo">155</span>    <a name="line.155"></a>
<span class="sourceLineNo">156</span>    if(noMediaObjectIds &amp;&amp; noObjectIds){<a name="line.156"></a>
<span class="sourceLineNo">157</span>      LOGGER.debug("No media object ids or object ids.");<a name="line.157"></a>
<span class="sourceLineNo">158</span>      return;<a name="line.158"></a>
<span class="sourceLineNo">159</span>    }<a name="line.159"></a>
<span class="sourceLineNo">160</span>    <a name="line.160"></a>
<span class="sourceLineNo">161</span>    SolrQueryBuilder query = new SolrQueryBuilder();<a name="line.161"></a>
<span class="sourceLineNo">162</span>    query.addFields(FIELDS_RESOLVE_OBJECT_IDS);<a name="line.162"></a>
<span class="sourceLineNo">163</span>    if(!noMediaObjectIds){<a name="line.163"></a>
<span class="sourceLineNo">164</span>      query.addCustomFilter(new OrQueryFilter(SOLR_FIELD_ID, mediaObjectIds));<a name="line.164"></a>
<span class="sourceLineNo">165</span>    }<a name="line.165"></a>
<span class="sourceLineNo">166</span>    <a name="line.166"></a>
<span class="sourceLineNo">167</span>    if(!noObjectIds){<a name="line.167"></a>
<span class="sourceLineNo">168</span>      for(Entry&lt;Integer, HashSet&lt;String&gt;&gt; e : backendIdObjectIdMap.entrySet()){<a name="line.168"></a>
<span class="sourceLineNo">169</span>        query.addCustomFilter(new OrSubQueryFilter(new AbstractQueryFilter[]{new AndQueryFilter(Definitions.SOLR_FIELD_BACKEND_ID, e.getKey()), new AndQueryFilter(Definitions.SOLR_FIELD_CREATOR_OBJECT_ID, e.getValue())}));<a name="line.169"></a>
<span class="sourceLineNo">170</span>      }<a name="line.170"></a>
<span class="sourceLineNo">171</span>    }<a name="line.171"></a>
<span class="sourceLineNo">172</span>    <a name="line.172"></a>
<span class="sourceLineNo">173</span>    List&lt;MediaObject&gt; results = getSolrTemplate(BEAN_ID_SOLR_SERVER).queryForList(query.toSolrQuery(Definitions.ELEMENT_MEDIA_OBJECTLIST), MediaObject.class);<a name="line.173"></a>
<span class="sourceLineNo">174</span>    if(results == null){<a name="line.174"></a>
<span class="sourceLineNo">175</span>      LOGGER.debug("No results.");<a name="line.175"></a>
<span class="sourceLineNo">176</span>      return;<a name="line.176"></a>
<span class="sourceLineNo">177</span>    }<a name="line.177"></a>
<span class="sourceLineNo">178</span>    <a name="line.178"></a>
<span class="sourceLineNo">179</span>    for(MediaObject object : objects){<a name="line.179"></a>
<span class="sourceLineNo">180</span>      for(MediaObject result : results){<a name="line.180"></a>
<span class="sourceLineNo">181</span>        if(result.getMediaObjectId().equals(object.getMediaObjectId())){<a name="line.181"></a>
<span class="sourceLineNo">182</span>          UserIdentity oUserId = object.getOwnerUserId();<a name="line.182"></a>
<span class="sourceLineNo">183</span>          UserIdentity rUserId = result.getOwnerUserId();<a name="line.183"></a>
<span class="sourceLineNo">184</span>          if(oUserId != null &amp;&amp; !UserIdentity.equals(oUserId, rUserId)){<a name="line.184"></a>
<span class="sourceLineNo">185</span>            LOGGER.warn("Replacing conflicting userId.");<a name="line.185"></a>
<span class="sourceLineNo">186</span>          }<a name="line.186"></a>
<span class="sourceLineNo">187</span>          object.setOwnerUserId(rUserId);<a name="line.187"></a>
<span class="sourceLineNo">188</span>          <a name="line.188"></a>
<span class="sourceLineNo">189</span>          String oObjectId = object.getObjectId();<a name="line.189"></a>
<span class="sourceLineNo">190</span>          String rObjectId = result.getObjectId();<a name="line.190"></a>
<span class="sourceLineNo">191</span>          if(oObjectId != null &amp;&amp; !oObjectId.equals(rObjectId )){<a name="line.191"></a>
<span class="sourceLineNo">192</span>            LOGGER.warn("Replacing conflicting objectId.");<a name="line.192"></a>
<span class="sourceLineNo">193</span>          }<a name="line.193"></a>
<span class="sourceLineNo">194</span>          object.setObjectId(rObjectId);<a name="line.194"></a>
<span class="sourceLineNo">195</span>          <a name="line.195"></a>
<span class="sourceLineNo">196</span>          Integer oBackendId = object.getBackendId();<a name="line.196"></a>
<span class="sourceLineNo">197</span>          Integer rBackendId = result.getBackendId();<a name="line.197"></a>
<span class="sourceLineNo">198</span>          if(oBackendId != null &amp;&amp; !oBackendId.equals(rBackendId)){<a name="line.198"></a>
<span class="sourceLineNo">199</span>            LOGGER.warn("Replacing conflicting backendId.");<a name="line.199"></a>
<span class="sourceLineNo">200</span>          }<a name="line.200"></a>
<span class="sourceLineNo">201</span>          object.setBackendId(rBackendId);<a name="line.201"></a>
<span class="sourceLineNo">202</span>        }else if(result.getObjectId().equals(object.getObjectId())){<a name="line.202"></a>
<span class="sourceLineNo">203</span>          Integer rBackendId = result.getBackendId();<a name="line.203"></a>
<span class="sourceLineNo">204</span>          Integer oBackendId = object.getBackendId();<a name="line.204"></a>
<span class="sourceLineNo">205</span>          if((rBackendId == null &amp;&amp; oBackendId == null) || (rBackendId != null &amp;&amp; rBackendId.equals(oBackendId))){<a name="line.205"></a>
<span class="sourceLineNo">206</span>            UserIdentity oUserId = object.getOwnerUserId();<a name="line.206"></a>
<span class="sourceLineNo">207</span>            UserIdentity rUserId = result.getOwnerUserId();<a name="line.207"></a>
<span class="sourceLineNo">208</span>            if(oUserId != null &amp;&amp; !UserIdentity.equals(oUserId, rUserId)){<a name="line.208"></a>
<span class="sourceLineNo">209</span>              LOGGER.warn("Replacing conflicting userId.");<a name="line.209"></a>
<span class="sourceLineNo">210</span>            }<a name="line.210"></a>
<span class="sourceLineNo">211</span>            object.setOwnerUserId(rUserId);<a name="line.211"></a>
<span class="sourceLineNo">212</span>            object.setMediaObjectId(result.getMediaObjectId());<a name="line.212"></a>
<span class="sourceLineNo">213</span>          } // if it is a match<a name="line.213"></a>
<span class="sourceLineNo">214</span>        } // else ignore non-matching media object, this can be later matched or new object without a match<a name="line.214"></a>
<span class="sourceLineNo">215</span>      } // for results<a name="line.215"></a>
<span class="sourceLineNo">216</span>    } // for objects<a name="line.216"></a>
<span class="sourceLineNo">217</span>  }<a name="line.217"></a>
<span class="sourceLineNo">218</span>  <a name="line.218"></a>
<span class="sourceLineNo">219</span>  /**<a name="line.219"></a>
<span class="sourceLineNo">220</span>   * Sets all missing ids for the given media objects if ids are found. <a name="line.220"></a>
<span class="sourceLineNo">221</span>   * Objects without valid mediaObjectId or backendId+objectId pair are ignored.<a name="line.221"></a>
<span class="sourceLineNo">222</span>   * <a name="line.222"></a>
<span class="sourceLineNo">223</span>   * @param mediaObjects<a name="line.223"></a>
<span class="sourceLineNo">224</span>   */<a name="line.224"></a>
<span class="sourceLineNo">225</span>  public void resolveObjectIds(MediaObjectList mediaObjects){<a name="line.225"></a>
<span class="sourceLineNo">226</span>    if(MediaObjectList.isEmpty(mediaObjects)){<a name="line.226"></a>
<span class="sourceLineNo">227</span>      LOGGER.debug("Empty object list.");<a name="line.227"></a>
<span class="sourceLineNo">228</span>      return;<a name="line.228"></a>
<span class="sourceLineNo">229</span>    }<a name="line.229"></a>
<span class="sourceLineNo">230</span>  <a name="line.230"></a>
<span class="sourceLineNo">231</span>    HashSet&lt;String&gt; mediaObjectIds = new HashSet&lt;&gt;();<a name="line.231"></a>
<span class="sourceLineNo">232</span>    HashMap&lt;Integer, HashSet&lt;String&gt;&gt; backendIdObjectIdMap = new HashMap&lt;&gt;();<a name="line.232"></a>
<span class="sourceLineNo">233</span>    List&lt;MediaObject&gt; objects = mediaObjects.getMediaObjects();<a name="line.233"></a>
<span class="sourceLineNo">234</span>    for(Iterator&lt;MediaObject&gt; vIter = objects.iterator(); vIter.hasNext();){ // get media object ids, backend ids and object ids<a name="line.234"></a>
<span class="sourceLineNo">235</span>      MediaObject vo = vIter.next();<a name="line.235"></a>
<span class="sourceLineNo">236</span>      String mediaObjectId = vo.getMediaObjectId();<a name="line.236"></a>
<span class="sourceLineNo">237</span>      if(!StringUtils.isBlank(mediaObjectId)){<a name="line.237"></a>
<span class="sourceLineNo">238</span>        mediaObjectIds.add(mediaObjectId);<a name="line.238"></a>
<span class="sourceLineNo">239</span>      }else{<a name="line.239"></a>
<span class="sourceLineNo">240</span>        String objectId = vo.getObjectId();<a name="line.240"></a>
<span class="sourceLineNo">241</span>        if(!StringUtils.isBlank(objectId)){<a name="line.241"></a>
<span class="sourceLineNo">242</span>          Integer backendId = vo.getBackendId();<a name="line.242"></a>
<span class="sourceLineNo">243</span>          HashSet&lt;String&gt; objectIds = backendIdObjectIdMap.get(backendId);<a name="line.243"></a>
<span class="sourceLineNo">244</span>          if(objectIds == null){<a name="line.244"></a>
<span class="sourceLineNo">245</span>            objectIds = new HashSet&lt;&gt;();<a name="line.245"></a>
<span class="sourceLineNo">246</span>            backendIdObjectIdMap.put(backendId, objectIds);<a name="line.246"></a>
<span class="sourceLineNo">247</span>          }<a name="line.247"></a>
<span class="sourceLineNo">248</span>          objectIds.add(objectId);<a name="line.248"></a>
<span class="sourceLineNo">249</span>        }else{<a name="line.249"></a>
<span class="sourceLineNo">250</span>          LOGGER.debug("Ignored media object without objectId and mediaObjectId.");<a name="line.250"></a>
<span class="sourceLineNo">251</span>        }<a name="line.251"></a>
<span class="sourceLineNo">252</span>      }<a name="line.252"></a>
<span class="sourceLineNo">253</span>    }<a name="line.253"></a>
<span class="sourceLineNo">254</span>    resolveObjectIds(backendIdObjectIdMap, mediaObjectIds, objects);<a name="line.254"></a>
<span class="sourceLineNo">255</span>  }<a name="line.255"></a>
<span class="sourceLineNo">256</span>  <a name="line.256"></a>
<span class="sourceLineNo">257</span>  /**<a name="line.257"></a>
<span class="sourceLineNo">258</span>   * <a name="line.258"></a>
<span class="sourceLineNo">259</span>   * @param objects<a name="line.259"></a>
<span class="sourceLineNo">260</span>   * @return true on success. Note that &lt;i&gt;nothing updated&lt;/i&gt; equals to success if no other errors are present.<a name="line.260"></a>
<span class="sourceLineNo">261</span>   */<a name="line.261"></a>
<span class="sourceLineNo">262</span>  public boolean updateIfNewer(MediaObjectList objects){<a name="line.262"></a>
<span class="sourceLineNo">263</span>    return update(objects, true);<a name="line.263"></a>
<span class="sourceLineNo">264</span>  }<a name="line.264"></a>
<span class="sourceLineNo">265</span>  <a name="line.265"></a>
<span class="sourceLineNo">266</span>  /**<a name="line.266"></a>
<span class="sourceLineNo">267</span>   * <a name="line.267"></a>
<span class="sourceLineNo">268</span>   * @param objects<a name="line.268"></a>
<span class="sourceLineNo">269</span>   * @return true on success<a name="line.269"></a>
<span class="sourceLineNo">270</span>   */<a name="line.270"></a>
<span class="sourceLineNo">271</span>  public boolean update(MediaObjectList objects){<a name="line.271"></a>
<span class="sourceLineNo">272</span>    return update(objects, false);<a name="line.272"></a>
<span class="sourceLineNo">273</span>  }<a name="line.273"></a>
<span class="sourceLineNo">274</span><a name="line.274"></a>
<span class="sourceLineNo">275</span>  /**<a name="line.275"></a>
<span class="sourceLineNo">276</span>   * The objects must have a valid id, either objectId (provided by back-end or client) + backendId (Note: null is a valid backendId if object created by the user) or mediaObjectId (provided by system)<a name="line.276"></a>
<span class="sourceLineNo">277</span>   * <a name="line.277"></a>
<span class="sourceLineNo">278</span>   * @param objects<a name="line.278"></a>
<span class="sourceLineNo">279</span>   * @param onlyNewer if true, only the objects which are newer will be added to the database. If the passed object does not have updated set, it will be ignored if onlyNewer is true.<a name="line.279"></a>
<span class="sourceLineNo">280</span>   * @return true on success<a name="line.280"></a>
<span class="sourceLineNo">281</span>   */<a name="line.281"></a>
<span class="sourceLineNo">282</span>  private boolean update(MediaObjectList objects, boolean onlyNewer){<a name="line.282"></a>
<span class="sourceLineNo">283</span>    if(MediaObjectList.isEmpty(objects)){<a name="line.283"></a>
<span class="sourceLineNo">284</span>      LOGGER.debug("Ignored empty object list.");<a name="line.284"></a>
<span class="sourceLineNo">285</span>      return true;<a name="line.285"></a>
<span class="sourceLineNo">286</span>    }<a name="line.286"></a>
<span class="sourceLineNo">287</span>    if(!MediaObjectList.isValid(objects)){<a name="line.287"></a>
<span class="sourceLineNo">288</span>      LOGGER.warn("Tried update with invalid object list.");<a name="line.288"></a>
<span class="sourceLineNo">289</span>      return false;<a name="line.289"></a>
<span class="sourceLineNo">290</span>    }<a name="line.290"></a>
<span class="sourceLineNo">291</span>    <a name="line.291"></a>
<span class="sourceLineNo">292</span>    List&lt;String&gt; voids = objects.getMediaObjectIds();<a name="line.292"></a>
<span class="sourceLineNo">293</span>    if(voids == null){<a name="line.293"></a>
<span class="sourceLineNo">294</span>      LOGGER.warn("Could not get media object ids.");<a name="line.294"></a>
<span class="sourceLineNo">295</span>      return false;<a name="line.295"></a>
<span class="sourceLineNo">296</span>    }<a name="line.296"></a>
<span class="sourceLineNo">297</span>    <a name="line.297"></a>
<span class="sourceLineNo">298</span>    SolrQueryBuilder solr = new SolrQueryBuilder();<a name="line.298"></a>
<span class="sourceLineNo">299</span>    solr.addFields(FIELDS_UPDATE);<a name="line.299"></a>
<span class="sourceLineNo">300</span>    if(onlyNewer){<a name="line.300"></a>
<span class="sourceLineNo">301</span>      solr.addField(Definitions.SOLR_FIELD_UPDATED);<a name="line.301"></a>
<span class="sourceLineNo">302</span>    }<a name="line.302"></a>
<span class="sourceLineNo">303</span>    SimpleSolrTemplate t = getSolrTemplate(BEAN_ID_SOLR_SERVER);<a name="line.303"></a>
<span class="sourceLineNo">304</span>    List&lt;MediaObject&gt; refList = new ArrayList&lt;&gt;();<a name="line.304"></a>
<span class="sourceLineNo">305</span><a name="line.305"></a>
<span class="sourceLineNo">306</span>    solr.clearCustomFilters();<a name="line.306"></a>
<span class="sourceLineNo">307</span>    solr.addCustomFilter(new AndQueryFilter(SOLR_FIELD_ID, voids));<a name="line.307"></a>
<span class="sourceLineNo">308</span>    refList = t.queryForList(solr.toSolrQuery(Definitions.ELEMENT_MEDIA_OBJECTLIST), MediaObject.class);<a name="line.308"></a>
<span class="sourceLineNo">309</span>    if(refList.isEmpty()){<a name="line.309"></a>
<span class="sourceLineNo">310</span>      LOGGER.warn("Tried to update non-existent objects.");<a name="line.310"></a>
<span class="sourceLineNo">311</span>      return false;<a name="line.311"></a>
<span class="sourceLineNo">312</span>    }<a name="line.312"></a>
<span class="sourceLineNo">313</span>    <a name="line.313"></a>
<span class="sourceLineNo">314</span>    MediaObjectList references = MediaObjectList.getMediaObjectList(refList, null);<a name="line.314"></a>
<span class="sourceLineNo">315</span>    <a name="line.315"></a>
<span class="sourceLineNo">316</span>    List&lt;MediaObject&gt; mediaObjects = objects.getMediaObjects();<a name="line.316"></a>
<span class="sourceLineNo">317</span>    List&lt;MediaObject&gt; update = new ArrayList&lt;&gt;(mediaObjects.size());<a name="line.317"></a>
<span class="sourceLineNo">318</span>    Date updated = new Date();<a name="line.318"></a>
<span class="sourceLineNo">319</span>    for(MediaObject object : mediaObjects){ // check for that userId, backendId or objectId is not being changed<a name="line.319"></a>
<span class="sourceLineNo">320</span>      String mediaObjectId = object.getMediaObjectId();<a name="line.320"></a>
<span class="sourceLineNo">321</span>      MediaObject reference = references.getMediaObject(mediaObjectId);<a name="line.321"></a>
<span class="sourceLineNo">322</span>      if(reference == null){<a name="line.322"></a>
<span class="sourceLineNo">323</span>        LOGGER.warn("Tried to update non-existent object, id: "+mediaObjectId);<a name="line.323"></a>
<span class="sourceLineNo">324</span>        return false;<a name="line.324"></a>
<span class="sourceLineNo">325</span>      }else if(!reference.getObjectId().equals(object.getObjectId())){<a name="line.325"></a>
<span class="sourceLineNo">326</span>        LOGGER.warn("Object creator id mismatch for object, id: "+mediaObjectId);<a name="line.326"></a>
<span class="sourceLineNo">327</span>        return false;<a name="line.327"></a>
<span class="sourceLineNo">328</span>      }else if(!UserIdentity.equals(reference.getOwnerUserId(), object.getOwnerUserId())){<a name="line.328"></a>
<span class="sourceLineNo">329</span>        LOGGER.warn("Object user identity mismatch for object, id: "+mediaObjectId);<a name="line.329"></a>
<span class="sourceLineNo">330</span>        return false;<a name="line.330"></a>
<span class="sourceLineNo">331</span>      }else{<a name="line.331"></a>
<span class="sourceLineNo">332</span>        Integer rBackendId = reference.getBackendId();<a name="line.332"></a>
<span class="sourceLineNo">333</span>        Integer oBackendId = object.getBackendId();<a name="line.333"></a>
<span class="sourceLineNo">334</span>        if(rBackendId != null){<a name="line.334"></a>
<span class="sourceLineNo">335</span>          if(!rBackendId.equals(oBackendId)){<a name="line.335"></a>
<span class="sourceLineNo">336</span>            LOGGER.warn("Object backend id mismatch for object, id: "+mediaObjectId);<a name="line.336"></a>
<span class="sourceLineNo">337</span>            return false;<a name="line.337"></a>
<span class="sourceLineNo">338</span>          }<a name="line.338"></a>
<span class="sourceLineNo">339</span>        }else if(oBackendId != null){ // both are not null<a name="line.339"></a>
<span class="sourceLineNo">340</span>          LOGGER.warn("Object backend id mismatch for object, id: "+mediaObjectId);<a name="line.340"></a>
<span class="sourceLineNo">341</span>          return false;<a name="line.341"></a>
<span class="sourceLineNo">342</span>        }<a name="line.342"></a>
<span class="sourceLineNo">343</span>      }<a name="line.343"></a>
<span class="sourceLineNo">344</span>      Date oUpdated = object.getUpdated();<a name="line.344"></a>
<span class="sourceLineNo">345</span>      if(onlyNewer){<a name="line.345"></a>
<span class="sourceLineNo">346</span>        if(oUpdated == null){<a name="line.346"></a>
<span class="sourceLineNo">347</span>          LOGGER.warn("Ignored object without updated timestamp, id: "+mediaObjectId);<a name="line.347"></a>
<span class="sourceLineNo">348</span>          continue;<a name="line.348"></a>
<span class="sourceLineNo">349</span>        }else if(oUpdated.before(reference.getUpdated())){<a name="line.349"></a>
<span class="sourceLineNo">350</span>          LOGGER.debug("Ignored object with older timestamp, id: "+mediaObjectId);<a name="line.350"></a>
<span class="sourceLineNo">351</span>          continue;<a name="line.351"></a>
<span class="sourceLineNo">352</span>        }<a name="line.352"></a>
<span class="sourceLineNo">353</span>      }else if(oUpdated == null){<a name="line.353"></a>
<span class="sourceLineNo">354</span>        object.setUpdated(updated); // make sure there is a timestamp<a name="line.354"></a>
<span class="sourceLineNo">355</span>      }<a name="line.355"></a>
<span class="sourceLineNo">356</span>      if(object.getVisibility() == null){<a name="line.356"></a>
<span class="sourceLineNo">357</span>        LOGGER.debug("Object is missing visibility, using default: "+DEFAULT_VISIBILITY.name());<a name="line.357"></a>
<span class="sourceLineNo">358</span>        object.setVisibility(DEFAULT_VISIBILITY);<a name="line.358"></a>
<span class="sourceLineNo">359</span>      }<a name="line.359"></a>
<span class="sourceLineNo">360</span>      update.add(object);<a name="line.360"></a>
<span class="sourceLineNo">361</span>    }<a name="line.361"></a>
<span class="sourceLineNo">362</span>    <a name="line.362"></a>
<span class="sourceLineNo">363</span>    if(t.addBeans(update).getStatus() == SolrException.ErrorCode.UNKNOWN.code){<a name="line.363"></a>
<span class="sourceLineNo">364</span>      return true;<a name="line.364"></a>
<span class="sourceLineNo">365</span>    }else{<a name="line.365"></a>
<span class="sourceLineNo">366</span>      LOGGER.warn("Failed to update media objects.");<a name="line.366"></a>
<span class="sourceLineNo">367</span>      return false;<a name="line.367"></a>
<span class="sourceLineNo">368</span>    }<a name="line.368"></a>
<span class="sourceLineNo">369</span>  }<a name="line.369"></a>
<span class="sourceLineNo">370</span><a name="line.370"></a>
<span class="sourceLineNo">371</span>  <a name="line.371"></a>
<span class="sourceLineNo">372</span>  <a name="line.372"></a>
<span class="sourceLineNo">373</span>  /**<a name="line.373"></a>
<span class="sourceLineNo">374</span>   * This will also automatically remove any associations between the given media objects and their photos.<a name="line.374"></a>
<span class="sourceLineNo">375</span>   * <a name="line.375"></a>
<span class="sourceLineNo">376</span>   * @param mediaobjectIds<a name="line.376"></a>
<span class="sourceLineNo">377</span>   * @return true on success<a name="line.377"></a>
<span class="sourceLineNo">378</span>   */<a name="line.378"></a>
<span class="sourceLineNo">379</span>  public boolean remove(Collection&lt;String&gt; mediaobjectIds){<a name="line.379"></a>
<span class="sourceLineNo">380</span>    if(mediaobjectIds == null || mediaobjectIds.isEmpty()){<a name="line.380"></a>
<span class="sourceLineNo">381</span>      LOGGER.debug("Ignored empty media object id list.");<a name="line.381"></a>
<span class="sourceLineNo">382</span>      return true;<a name="line.382"></a>
<span class="sourceLineNo">383</span>    }<a name="line.383"></a>
<span class="sourceLineNo">384</span>    <a name="line.384"></a>
<span class="sourceLineNo">385</span>    for(String mediaObjectId : mediaobjectIds){ // remove associations<a name="line.385"></a>
<span class="sourceLineNo">386</span>      _photoDAO.deassociate(null, mediaObjectId);<a name="line.386"></a>
<span class="sourceLineNo">387</span>    }<a name="line.387"></a>
<span class="sourceLineNo">388</span>    SimpleSolrTemplate template = getSolrTemplate(BEAN_ID_SOLR_SERVER);<a name="line.388"></a>
<span class="sourceLineNo">389</span>    if(template.deleteById(mediaobjectIds).getStatus() == SolrException.ErrorCode.UNKNOWN.code){<a name="line.389"></a>
<span class="sourceLineNo">390</span>      return true;<a name="line.390"></a>
<span class="sourceLineNo">391</span>    }else{<a name="line.391"></a>
<span class="sourceLineNo">392</span>      LOGGER.warn("Failed to remove media objects.");<a name="line.392"></a>
<span class="sourceLineNo">393</span>      return false;<a name="line.393"></a>
<span class="sourceLineNo">394</span>    }<a name="line.394"></a>
<span class="sourceLineNo">395</span>  }<a name="line.395"></a>
<span class="sourceLineNo">396</span>  <a name="line.396"></a>
<span class="sourceLineNo">397</span>  /**<a name="line.397"></a>
<span class="sourceLineNo">398</span>   * <a name="line.398"></a>
<span class="sourceLineNo">399</span>   * @param dataGroups<a name="line.399"></a>
<span class="sourceLineNo">400</span>   * @param limits<a name="line.400"></a>
<span class="sourceLineNo">401</span>   * @param mediaTypes target media types for the retrieval<a name="line.401"></a>
<span class="sourceLineNo">402</span>   * @param serviceTypes<a name="line.402"></a>
<span class="sourceLineNo">403</span>   * @param mediaObjectIds<a name="line.403"></a>
<span class="sourceLineNo">404</span>   * @param userIdFilter<a name="line.404"></a>
<span class="sourceLineNo">405</span>   * @return list of media objects or null if none was found<a name="line.405"></a>
<span class="sourceLineNo">406</span>   * @throws IllegalArgumentException on bad query terms<a name="line.406"></a>
<span class="sourceLineNo">407</span>   */<a name="line.407"></a>
<span class="sourceLineNo">408</span>  public MediaObjectList getMediaObjects(DataGroups dataGroups, Limits limits, EnumSet&lt;MediaType&gt; mediaTypes, EnumSet&lt;ServiceType&gt; serviceTypes, Collection&lt;String&gt; mediaObjectIds, long[] userIdFilter) throws IllegalArgumentException {<a name="line.408"></a>
<span class="sourceLineNo">409</span>    if(mediaTypes == null || mediaTypes.isEmpty()){<a name="line.409"></a>
<span class="sourceLineNo">410</span>      throw new IllegalArgumentException("Invalid MediaType "+MediaType.class.toString()+" given.");<a name="line.410"></a>
<span class="sourceLineNo">411</span>    }<a name="line.411"></a>
<span class="sourceLineNo">412</span>    return getMediaObjectList(dataGroups, limits, mediaTypes, serviceTypes, mediaObjectIds, userIdFilter);<a name="line.412"></a>
<span class="sourceLineNo">413</span>  }<a name="line.413"></a>
<span class="sourceLineNo">414</span><a name="line.414"></a>
<span class="sourceLineNo">415</span>  /**<a name="line.415"></a>
<span class="sourceLineNo">416</span>   * helper method for retrieving the media object list<a name="line.416"></a>
<span class="sourceLineNo">417</span>   * <a name="line.417"></a>
<span class="sourceLineNo">418</span>   * @param dataGroups<a name="line.418"></a>
<span class="sourceLineNo">419</span>   * @param limits<a name="line.419"></a>
<span class="sourceLineNo">420</span>   * @param mediaTypes target media types, not null, nor empty<a name="line.420"></a>
<span class="sourceLineNo">421</span>   * @param serviceTypes<a name="line.421"></a>
<span class="sourceLineNo">422</span>   * @param mediaObjectIds<a name="line.422"></a>
<span class="sourceLineNo">423</span>   * @param userIdFilter<a name="line.423"></a>
<span class="sourceLineNo">424</span>   * @return list of media objects or null if none was found<a name="line.424"></a>
<span class="sourceLineNo">425</span>   */<a name="line.425"></a>
<span class="sourceLineNo">426</span>  private MediaObjectList getMediaObjectList(DataGroups dataGroups, Limits limits, EnumSet&lt;MediaType&gt; mediaTypes, EnumSet&lt;ServiceType&gt; serviceTypes, Collection&lt;String&gt; mediaObjectIds, long[] userIdFilter) {<a name="line.426"></a>
<span class="sourceLineNo">427</span>    SolrQueryBuilder solr = new SolrQueryBuilder();<a name="line.427"></a>
<span class="sourceLineNo">428</span>    if(!processDataGroups(dataGroups, solr)){<a name="line.428"></a>
<span class="sourceLineNo">429</span>      LOGGER.debug("Process data groups did not result viable combination for search, returning null...");<a name="line.429"></a>
<span class="sourceLineNo">430</span>      return null;<a name="line.430"></a>
<span class="sourceLineNo">431</span>    }<a name="line.431"></a>
<span class="sourceLineNo">432</span>    <a name="line.432"></a>
<span class="sourceLineNo">433</span>    solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_MEDIA_TYPE, MediaType.toInt(mediaTypes)));<a name="line.433"></a>
<span class="sourceLineNo">434</span>    <a name="line.434"></a>
<span class="sourceLineNo">435</span>    if(!ServiceType.isEmpty(serviceTypes)){<a name="line.435"></a>
<span class="sourceLineNo">436</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_SERVICE_ID, ServiceType.toIdArray(serviceTypes)));<a name="line.436"></a>
<span class="sourceLineNo">437</span>    }<a name="line.437"></a>
<span class="sourceLineNo">438</span>    <a name="line.438"></a>
<span class="sourceLineNo">439</span>    if(mediaObjectIds != null &amp;&amp; !mediaObjectIds.isEmpty()){<a name="line.439"></a>
<span class="sourceLineNo">440</span>      solr.addCustomFilter(new AndQueryFilter(SOLR_FIELD_ID, mediaObjectIds));<a name="line.440"></a>
<span class="sourceLineNo">441</span>    }<a name="line.441"></a>
<span class="sourceLineNo">442</span>    <a name="line.442"></a>
<span class="sourceLineNo">443</span>    if(userIdFilter != null){<a name="line.443"></a>
<span class="sourceLineNo">444</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_USER_ID, userIdFilter));<a name="line.444"></a>
<span class="sourceLineNo">445</span>    }<a name="line.445"></a>
<span class="sourceLineNo">446</span>    <a name="line.446"></a>
<span class="sourceLineNo">447</span>    solr.setSortOptions(DEFAULT_SORT_OPTIONS);<a name="line.447"></a>
<span class="sourceLineNo">448</span>    solr.setLimits(limits);<a name="line.448"></a>
<span class="sourceLineNo">449</span>    <a name="line.449"></a>
<span class="sourceLineNo">450</span>    QueryResponse response = getSolrTemplate(BEAN_ID_SOLR_SERVER).query(solr.toSolrQuery(Definitions.ELEMENT_MEDIA_OBJECTLIST));<a name="line.450"></a>
<span class="sourceLineNo">451</span>    List&lt;MediaObject&gt; mediaObjects = SimpleSolrTemplate.getList(response, MediaObject.class);<a name="line.451"></a>
<span class="sourceLineNo">452</span>    if(mediaObjects == null){<a name="line.452"></a>
<span class="sourceLineNo">453</span>      LOGGER.debug("No results.");<a name="line.453"></a>
<span class="sourceLineNo">454</span>      return null;<a name="line.454"></a>
<span class="sourceLineNo">455</span>    }<a name="line.455"></a>
<span class="sourceLineNo">456</span>    <a name="line.456"></a>
<span class="sourceLineNo">457</span>    ResultInfo info = null;<a name="line.457"></a>
<span class="sourceLineNo">458</span>    if(DataGroups.hasDataGroup(Definitions.DATA_GROUP_RESULT_INFO, dataGroups)){<a name="line.458"></a>
<span class="sourceLineNo">459</span>      LOGGER.debug("Resolving result info for the requested objects.");<a name="line.459"></a>
<span class="sourceLineNo">460</span>      info = new ResultInfo(limits.getStartItem(Definitions.ELEMENT_MEDIA_OBJECTLIST), limits.getEndItem(Definitions.ELEMENT_MEDIA_OBJECTLIST), response.getResults().getNumFound());<a name="line.460"></a>
<span class="sourceLineNo">461</span>    }<a name="line.461"></a>
<span class="sourceLineNo">462</span>    <a name="line.462"></a>
<span class="sourceLineNo">463</span>    MediaObjectList voList = MediaObjectList.getMediaObjectList(mediaObjects, info);<a name="line.463"></a>
<span class="sourceLineNo">464</span>    _keywordsDAO.assignFriendlyKeywords(voList);<a name="line.464"></a>
<span class="sourceLineNo">465</span>    return voList;<a name="line.465"></a>
<span class="sourceLineNo">466</span>  }<a name="line.466"></a>
<span class="sourceLineNo">467</span>  <a name="line.467"></a>
<span class="sourceLineNo">468</span>  /**<a name="line.468"></a>
<span class="sourceLineNo">469</span>   * <a name="line.469"></a>
<span class="sourceLineNo">470</span>   * @param authenticatedUser<a name="line.470"></a>
<span class="sourceLineNo">471</span>   * @param dataGroups<a name="line.471"></a>
<span class="sourceLineNo">472</span>   * @param limits<a name="line.472"></a>
<span class="sourceLineNo">473</span>   * @param serviceTypes<a name="line.473"></a>
<span class="sourceLineNo">474</span>   * @param userIdFilter<a name="line.474"></a>
<span class="sourceLineNo">475</span>   * @param mediaObjectTerms list of terms to use for search. Note: if the objects have mediaObjectIds set, these will be directly used as filter<a name="line.475"></a>
<span class="sourceLineNo">476</span>   * @return list of ids or null if none<a name="line.476"></a>
<span class="sourceLineNo">477</span>   */<a name="line.477"></a>
<span class="sourceLineNo">478</span>  public List&lt;String&gt; getMediaObjectIds(UserIdentity authenticatedUser, DataGroups dataGroups, Limits limits, EnumSet&lt;ServiceType&gt; serviceTypes, long[] userIdFilter, MediaObjectList mediaObjectTerms) {<a name="line.478"></a>
<span class="sourceLineNo">479</span>    SolrQueryBuilder solr = new SolrQueryBuilder();<a name="line.479"></a>
<span class="sourceLineNo">480</span>    if(!processDataGroups(dataGroups, solr)){<a name="line.480"></a>
<span class="sourceLineNo">481</span>      LOGGER.debug("Process data groups did not result viable combination for search, returning null...");<a name="line.481"></a>
<span class="sourceLineNo">482</span>      return null;<a name="line.482"></a>
<span class="sourceLineNo">483</span>    }<a name="line.483"></a>
<span class="sourceLineNo">484</span>    <a name="line.484"></a>
<span class="sourceLineNo">485</span>    if(!UserIdentity.isValid(authenticatedUser)){<a name="line.485"></a>
<span class="sourceLineNo">486</span>      LOGGER.debug("Invalid authenticated user, limiting search to public content.");<a name="line.486"></a>
<span class="sourceLineNo">487</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_VISIBILITY, Visibility.PUBLIC.toInt()));<a name="line.487"></a>
<span class="sourceLineNo">488</span>    }else{<a name="line.488"></a>
<span class="sourceLineNo">489</span>      solr.addCustomFilter(new AndSubQueryFilter(new AbstractQueryFilter[]{new OrQueryFilter(Definitions.SOLR_FIELD_USER_ID, authenticatedUser.getUserId()), new OrQueryFilter(Definitions.SOLR_FIELD_VISIBILITY, Visibility.PUBLIC.toInt())}));<a name="line.489"></a>
<span class="sourceLineNo">490</span>    }<a name="line.490"></a>
<span class="sourceLineNo">491</span>    <a name="line.491"></a>
<span class="sourceLineNo">492</span>    if(!ServiceType.isEmpty(serviceTypes)){<a name="line.492"></a>
<span class="sourceLineNo">493</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_SERVICE_ID, ServiceType.toIdArray(serviceTypes)));<a name="line.493"></a>
<span class="sourceLineNo">494</span>    }<a name="line.494"></a>
<span class="sourceLineNo">495</span>    <a name="line.495"></a>
<span class="sourceLineNo">496</span>    if(!ArrayUtils.isEmpty(userIdFilter)){<a name="line.496"></a>
<span class="sourceLineNo">497</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_USER_ID, userIdFilter));<a name="line.497"></a>
<span class="sourceLineNo">498</span>    }<a name="line.498"></a>
<span class="sourceLineNo">499</span>    <a name="line.499"></a>
<span class="sourceLineNo">500</span>    processMediaObjects(solr, mediaObjectTerms);<a name="line.500"></a>
<span class="sourceLineNo">501</span>    <a name="line.501"></a>
<span class="sourceLineNo">502</span>    solr.setLimits(limits);<a name="line.502"></a>
<span class="sourceLineNo">503</span>    solr.setSortOptions(DEFAULT_SORT_OPTIONS);<a name="line.503"></a>
<span class="sourceLineNo">504</span>    solr.addField(SOLR_FIELD_ID);<a name="line.504"></a>
<span class="sourceLineNo">505</span>    <a name="line.505"></a>
<span class="sourceLineNo">506</span>    return SimpleSolrTemplate.getObjects(getSolrTemplate(BEAN_ID_SOLR_SERVER).query(solr.toSolrQuery(Definitions.ELEMENT_MEDIA_OBJECTLIST)), SOLR_FIELD_ID, String.class);<a name="line.506"></a>
<span class="sourceLineNo">507</span>  }<a name="line.507"></a>
<span class="sourceLineNo">508</span>  <a name="line.508"></a>
<span class="sourceLineNo">509</span>  /**<a name="line.509"></a>
<span class="sourceLineNo">510</span>   * <a name="line.510"></a>
<span class="sourceLineNo">511</span>   * @param solr<a name="line.511"></a>
<span class="sourceLineNo">512</span>   * @param mediaObjectTerms<a name="line.512"></a>
<span class="sourceLineNo">513</span>   * @throws IllegalArgumentException on too high term count<a name="line.513"></a>
<span class="sourceLineNo">514</span>   */<a name="line.514"></a>
<span class="sourceLineNo">515</span>  private void processMediaObjects(SolrQueryBuilder solr, MediaObjectList mediaObjectTerms) throws IllegalArgumentException {<a name="line.515"></a>
<span class="sourceLineNo">516</span>    if(MediaObjectList.isEmpty(mediaObjectTerms)){<a name="line.516"></a>
<span class="sourceLineNo">517</span>      LOGGER.debug("No media objects.");<a name="line.517"></a>
<span class="sourceLineNo">518</span>      return;<a name="line.518"></a>
<span class="sourceLineNo">519</span>    }<a name="line.519"></a>
<span class="sourceLineNo">520</span>    LOGGER.debug("Creating media object filters...");<a name="line.520"></a>
<span class="sourceLineNo">521</span>    <a name="line.521"></a>
<span class="sourceLineNo">522</span>    List&lt;MediaObject&gt; terms = mediaObjectTerms.getMediaObjects();<a name="line.522"></a>
<span class="sourceLineNo">523</span>    List&lt;String&gt; mediaObjectIds = new ArrayList&lt;&gt;();<a name="line.523"></a>
<span class="sourceLineNo">524</span>    List&lt;AbstractQueryFilter&gt; filters = new ArrayList&lt;&gt;();<a name="line.524"></a>
<span class="sourceLineNo">525</span>    for(MediaObject term : terms){<a name="line.525"></a>
<span class="sourceLineNo">526</span>      String mediaObjectId = term.getMediaObjectId();<a name="line.526"></a>
<span class="sourceLineNo">527</span>      if(!StringUtils.isBlank(mediaObjectId)){<a name="line.527"></a>
<span class="sourceLineNo">528</span>        LOGGER.debug("media object id was given, using as filter, id: "+mediaObjectId);<a name="line.528"></a>
<span class="sourceLineNo">529</span>        mediaObjectIds.add(mediaObjectId);<a name="line.529"></a>
<span class="sourceLineNo">530</span>      }else{<a name="line.530"></a>
<span class="sourceLineNo">531</span>        String value = term.getValue();<a name="line.531"></a>
<span class="sourceLineNo">532</span>        if(StringUtils.isBlank(value)){<a name="line.532"></a>
<span class="sourceLineNo">533</span>          LOGGER.debug("No value for visual object, attempting to use name.");<a name="line.533"></a>
<span class="sourceLineNo">534</span>          value = term.getName();<a name="line.534"></a>
<span class="sourceLineNo">535</span>          if(StringUtils.isBlank(value)){<a name="line.535"></a>
<span class="sourceLineNo">536</span>            LOGGER.warn("Ignording media object search term without value or name.");<a name="line.536"></a>
<span class="sourceLineNo">537</span>            continue;<a name="line.537"></a>
<span class="sourceLineNo">538</span>          }<a name="line.538"></a>
<span class="sourceLineNo">539</span>        }<a name="line.539"></a>
<span class="sourceLineNo">540</span>        <a name="line.540"></a>
<span class="sourceLineNo">541</span>        MediaObjectType type = term.getMediaObjectType();<a name="line.541"></a>
<span class="sourceLineNo">542</span>        if(type == null){<a name="line.542"></a>
<span class="sourceLineNo">543</span>          LOGGER.warn("No media object type, using default : "+DEFAULT_MEDIA_OBJECT_TYPE.name());<a name="line.543"></a>
<span class="sourceLineNo">544</span>          type = DEFAULT_MEDIA_OBJECT_TYPE;<a name="line.544"></a>
<span class="sourceLineNo">545</span>        }<a name="line.545"></a>
<span class="sourceLineNo">546</span>        OrSubQueryFilter subFilter = new OrSubQueryFilter();<a name="line.546"></a>
<span class="sourceLineNo">547</span>        <a name="line.547"></a>
<span class="sourceLineNo">548</span>        subFilter.addFilter(new AndQueryFilter(Definitions.SOLR_FIELD_VALUE_SEARCH, value));<a name="line.548"></a>
<span class="sourceLineNo">549</span>        subFilter.addFilter(new AndQueryFilter(Definitions.SOLR_FIELD_MEDIA_OBJECT_TYPE, type.toInt()));<a name="line.549"></a>
<span class="sourceLineNo">550</span>        <a name="line.550"></a>
<span class="sourceLineNo">551</span>        Visibility visibility = term.getVisibility();<a name="line.551"></a>
<span class="sourceLineNo">552</span>        if(visibility != null){<a name="line.552"></a>
<span class="sourceLineNo">553</span>          subFilter.addFilter(new AndQueryFilter(Definitions.SOLR_FIELD_VISIBILITY, visibility.toInt()));<a name="line.553"></a>
<span class="sourceLineNo">554</span>        }<a name="line.554"></a>
<span class="sourceLineNo">555</span>        <a name="line.555"></a>
<span class="sourceLineNo">556</span>        ServiceType serviceType = term.getServiceType();<a name="line.556"></a>
<span class="sourceLineNo">557</span>        if(serviceType != null){<a name="line.557"></a>
<span class="sourceLineNo">558</span>          subFilter.addFilter(new AndQueryFilter(Definitions.SOLR_FIELD_SERVICE_ID, serviceType.getServiceId()));<a name="line.558"></a>
<span class="sourceLineNo">559</span>        }<a name="line.559"></a>
<span class="sourceLineNo">560</span>        <a name="line.560"></a>
<span class="sourceLineNo">561</span>        ConfirmationStatus status = term.getConfirmationStatus();<a name="line.561"></a>
<span class="sourceLineNo">562</span>        if(status != null){<a name="line.562"></a>
<span class="sourceLineNo">563</span>          subFilter.addFilter(new AndQueryFilter(Definitions.SOLR_FIELD_STATUS, status.toInt()));<a name="line.563"></a>
<span class="sourceLineNo">564</span>        }<a name="line.564"></a>
<span class="sourceLineNo">565</span>        <a name="line.565"></a>
<span class="sourceLineNo">566</span>        Integer temp = term.getRank();<a name="line.566"></a>
<span class="sourceLineNo">567</span>        if(temp != null){<a name="line.567"></a>
<span class="sourceLineNo">568</span>          subFilter.addFilter(new RangeQueryFilter(Definitions.SOLR_FIELD_RANK, temp, null));<a name="line.568"></a>
<span class="sourceLineNo">569</span>        }<a name="line.569"></a>
<span class="sourceLineNo">570</span>        <a name="line.570"></a>
<span class="sourceLineNo">571</span>        temp = term.getBackendId();<a name="line.571"></a>
<span class="sourceLineNo">572</span>        if(temp != null){<a name="line.572"></a>
<span class="sourceLineNo">573</span>          subFilter.addFilter(new RangeQueryFilter(Definitions.SOLR_FIELD_BACKEND_ID, temp, null));<a name="line.573"></a>
<span class="sourceLineNo">574</span>        }<a name="line.574"></a>
<span class="sourceLineNo">575</span>        <a name="line.575"></a>
<span class="sourceLineNo">576</span>        Double confidence = term.getConfidence();<a name="line.576"></a>
<span class="sourceLineNo">577</span>        if(confidence != null){<a name="line.577"></a>
<span class="sourceLineNo">578</span>          subFilter.addFilter(new RangeQueryFilter(Definitions.SOLR_FIELD_CONFIDENCE, confidence, null));<a name="line.578"></a>
<span class="sourceLineNo">579</span>        }<a name="line.579"></a>
<span class="sourceLineNo">580</span>        <a name="line.580"></a>
<span class="sourceLineNo">581</span>        filters.add(subFilter);<a name="line.581"></a>
<span class="sourceLineNo">582</span>      }<a name="line.582"></a>
<span class="sourceLineNo">583</span>    } // for<a name="line.583"></a>
<span class="sourceLineNo">584</span>    <a name="line.584"></a>
<span class="sourceLineNo">585</span>    if(!filters.isEmpty()){<a name="line.585"></a>
<span class="sourceLineNo">586</span>      solr.addCustomFilter(new AndSubQueryFilter(filters.toArray(new AbstractQueryFilter[filters.size()])));<a name="line.586"></a>
<span class="sourceLineNo">587</span>    }<a name="line.587"></a>
<span class="sourceLineNo">588</span><a name="line.588"></a>
<span class="sourceLineNo">589</span>    if(!mediaObjectIds.isEmpty()){<a name="line.589"></a>
<span class="sourceLineNo">590</span>      solr.addCustomFilter(new AndQueryFilter(SOLR_FIELD_ID, mediaObjectIds));<a name="line.590"></a>
<span class="sourceLineNo">591</span>    }<a name="line.591"></a>
<span class="sourceLineNo">592</span>  }<a name="line.592"></a>
<span class="sourceLineNo">593</span>  <a name="line.593"></a>
<span class="sourceLineNo">594</span>  /**<a name="line.594"></a>
<span class="sourceLineNo">595</span>   * <a name="line.595"></a>
<span class="sourceLineNo">596</span>   * @param solr<a name="line.596"></a>
<span class="sourceLineNo">597</span>   * @param sortOptions <a name="line.597"></a>
<span class="sourceLineNo">598</span>   */<a name="line.598"></a>
<span class="sourceLineNo">599</span>  private void setOrderBy(SolrQueryBuilder solr, SortOptions sortOptions){<a name="line.599"></a>
<span class="sourceLineNo">600</span>    if(sortOptions == null || !sortOptions.hasValues()){<a name="line.600"></a>
<span class="sourceLineNo">601</span>      solr.setSortOptions(DEFAULT_SORT_OPTIONS);<a name="line.601"></a>
<span class="sourceLineNo">602</span>      return;<a name="line.602"></a>
<span class="sourceLineNo">603</span>    }<a name="line.603"></a>
<span class="sourceLineNo">604</span>    <a name="line.604"></a>
<span class="sourceLineNo">605</span>    Set&lt;Option&gt; so = sortOptions.getSortOptions(Definitions.ELEMENT_MEDIA_OBJECTLIST);<a name="line.605"></a>
<span class="sourceLineNo">606</span>    if(so == null){<a name="line.606"></a>
<span class="sourceLineNo">607</span>      return;<a name="line.607"></a>
<span class="sourceLineNo">608</span>    }<a name="line.608"></a>
<span class="sourceLineNo">609</span>    <a name="line.609"></a>
<span class="sourceLineNo">610</span>    for(Iterator&lt;Option&gt; iter = so.iterator();iter.hasNext();){<a name="line.610"></a>
<span class="sourceLineNo">611</span>      Option o = iter.next();<a name="line.611"></a>
<span class="sourceLineNo">612</span>      String elementName = o.getElementName();<a name="line.612"></a>
<span class="sourceLineNo">613</span>      if(Definitions.ELEMENT_CONFIDENCE.equals(elementName)){<a name="line.613"></a>
<span class="sourceLineNo">614</span>        solr.addSortOption(new Option(Definitions.SOLR_FIELD_CONFIDENCE, o.getOrderDirection(), Definitions.ELEMENT_MEDIA_OBJECTLIST));<a name="line.614"></a>
<span class="sourceLineNo">615</span>      }else if(Definitions.ELEMENT_RANK.equals(elementName)){<a name="line.615"></a>
<span class="sourceLineNo">616</span>        solr.addSortOption(new Option(Definitions.SOLR_FIELD_RANK, o.getOrderDirection(), Definitions.ELEMENT_MEDIA_OBJECTLIST));<a name="line.616"></a>
<span class="sourceLineNo">617</span>      }else if(Definitions.ELEMENT_VALUE.equals(elementName)){<a name="line.617"></a>
<span class="sourceLineNo">618</span>        solr.addSortOption(new Option(Definitions.SOLR_FIELD_VALUE, o.getOrderDirection(), Definitions.ELEMENT_MEDIA_OBJECTLIST));<a name="line.618"></a>
<span class="sourceLineNo">619</span>      }else{<a name="line.619"></a>
<span class="sourceLineNo">620</span>        LOGGER.debug("Ignored unknown sort element: "+elementName);<a name="line.620"></a>
<span class="sourceLineNo">621</span>      }<a name="line.621"></a>
<span class="sourceLineNo">622</span>    }<a name="line.622"></a>
<span class="sourceLineNo">623</span>  }<a name="line.623"></a>
<span class="sourceLineNo">624</span><a name="line.624"></a>
<span class="sourceLineNo">625</span>  /**<a name="line.625"></a>
<span class="sourceLineNo">626</span>   * Note that because of solr limitations, the media object count cannot exceed MAX_FILTER_COUNT.<a name="line.626"></a>
<span class="sourceLineNo">627</span>   * <a name="line.627"></a>
<span class="sourceLineNo">628</span>   * @param authenticatedUser<a name="line.628"></a>
<span class="sourceLineNo">629</span>   * @param dataGroups<a name="line.629"></a>
<span class="sourceLineNo">630</span>   * @param limits<a name="line.630"></a>
<span class="sourceLineNo">631</span>   * @param mediaTypes list of target media types for the search<a name="line.631"></a>
<span class="sourceLineNo">632</span>   * @param serviceTypes<a name="line.632"></a>
<span class="sourceLineNo">633</span>   * @param sortOptions<a name="line.633"></a>
<span class="sourceLineNo">634</span>   * @param userIdFilter<a name="line.634"></a>
<span class="sourceLineNo">635</span>   * @param mediaObjectTerms list of terms to use for search. Note: if the objects have mediaObjectIds set, these will be directly used as filter<a name="line.635"></a>
<span class="sourceLineNo">636</span>   * @return list of media objects or null if none was found<a name="line.636"></a>
<span class="sourceLineNo">637</span>   * @throws IllegalArgumentException on bad values<a name="line.637"></a>
<span class="sourceLineNo">638</span>   */<a name="line.638"></a>
<span class="sourceLineNo">639</span>  public MediaObjectList search(UserIdentity authenticatedUser, DataGroups dataGroups, Limits limits, EnumSet&lt;MediaType&gt; mediaTypes, EnumSet&lt;ServiceType&gt; serviceTypes, SortOptions sortOptions, long[] userIdFilter, MediaObjectList mediaObjectTerms) throws IllegalArgumentException {<a name="line.639"></a>
<span class="sourceLineNo">640</span>    if(mediaTypes == null || mediaTypes.isEmpty()){<a name="line.640"></a>
<span class="sourceLineNo">641</span>      throw new IllegalArgumentException("Invalid "+MediaType.class.toString()+" given.");<a name="line.641"></a>
<span class="sourceLineNo">642</span>    }<a name="line.642"></a>
<span class="sourceLineNo">643</span>    <a name="line.643"></a>
<span class="sourceLineNo">644</span>    SolrQueryBuilder solr = new SolrQueryBuilder();<a name="line.644"></a>
<span class="sourceLineNo">645</span>    <a name="line.645"></a>
<span class="sourceLineNo">646</span>    if(!processDataGroups(dataGroups, solr)){<a name="line.646"></a>
<span class="sourceLineNo">647</span>      LOGGER.debug("Process data groups did not result viable combination for search, returning null...");<a name="line.647"></a>
<span class="sourceLineNo">648</span>      return null;<a name="line.648"></a>
<span class="sourceLineNo">649</span>    }<a name="line.649"></a>
<span class="sourceLineNo">650</span>    <a name="line.650"></a>
<span class="sourceLineNo">651</span>    solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_MEDIA_TYPE, MediaType.toInt(mediaTypes)));<a name="line.651"></a>
<span class="sourceLineNo">652</span>    <a name="line.652"></a>
<span class="sourceLineNo">653</span>    processMediaObjects(solr, mediaObjectTerms); // throws IllegalArgumentException if term count exceeds maximum<a name="line.653"></a>
<span class="sourceLineNo">654</span>    <a name="line.654"></a>
<span class="sourceLineNo">655</span>    if(!UserIdentity.isValid(authenticatedUser)){<a name="line.655"></a>
<span class="sourceLineNo">656</span>      LOGGER.debug("Invalid authenticated user, limiting search to public content.");<a name="line.656"></a>
<span class="sourceLineNo">657</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_VISIBILITY, Visibility.PUBLIC.toInt()));<a name="line.657"></a>
<span class="sourceLineNo">658</span>    }else{<a name="line.658"></a>
<span class="sourceLineNo">659</span>      solr.addCustomFilter(new AndSubQueryFilter(new AbstractQueryFilter[]{new OrQueryFilter(Definitions.SOLR_FIELD_USER_ID, authenticatedUser.getUserId()), new OrQueryFilter(Definitions.SOLR_FIELD_VISIBILITY, Visibility.PUBLIC.toInt())}));<a name="line.659"></a>
<span class="sourceLineNo">660</span>    }<a name="line.660"></a>
<span class="sourceLineNo">661</span>    <a name="line.661"></a>
<span class="sourceLineNo">662</span>    if(!ServiceType.isEmpty(serviceTypes)){<a name="line.662"></a>
<span class="sourceLineNo">663</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_SERVICE_ID, ServiceType.toIdArray(serviceTypes)));<a name="line.663"></a>
<span class="sourceLineNo">664</span>    }<a name="line.664"></a>
<span class="sourceLineNo">665</span>    <a name="line.665"></a>
<span class="sourceLineNo">666</span>    if(!ArrayUtils.isEmpty(userIdFilter)){<a name="line.666"></a>
<span class="sourceLineNo">667</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_USER_ID, userIdFilter));<a name="line.667"></a>
<span class="sourceLineNo">668</span>    }<a name="line.668"></a>
<span class="sourceLineNo">669</span>    <a name="line.669"></a>
<span class="sourceLineNo">670</span>    solr.setLimits(limits);<a name="line.670"></a>
<span class="sourceLineNo">671</span>    setOrderBy(solr, sortOptions);<a name="line.671"></a>
<span class="sourceLineNo">672</span>    <a name="line.672"></a>
<span class="sourceLineNo">673</span>    QueryResponse response = getSolrTemplate(BEAN_ID_SOLR_SERVER).query(solr.toSolrQuery(Definitions.ELEMENT_MEDIA_OBJECTLIST));<a name="line.673"></a>
<span class="sourceLineNo">674</span>    List&lt;? extends MediaObject&gt; mediaObjects = SimpleSolrTemplate.getList(response, MediaObject.class);<a name="line.674"></a>
<span class="sourceLineNo">675</span>    if(mediaObjects == null){<a name="line.675"></a>
<span class="sourceLineNo">676</span>      LOGGER.debug("No results.");<a name="line.676"></a>
<span class="sourceLineNo">677</span>      return null;<a name="line.677"></a>
<span class="sourceLineNo">678</span>    }<a name="line.678"></a>
<span class="sourceLineNo">679</span>    <a name="line.679"></a>
<span class="sourceLineNo">680</span>    ResultInfo info = null;<a name="line.680"></a>
<span class="sourceLineNo">681</span>    if(DataGroups.hasDataGroup(Definitions.DATA_GROUP_RESULT_INFO, dataGroups)){<a name="line.681"></a>
<span class="sourceLineNo">682</span>      LOGGER.debug("Resolving result info for the requested objects.");<a name="line.682"></a>
<span class="sourceLineNo">683</span>      info = new ResultInfo(limits.getStartItem(Definitions.ELEMENT_MEDIA_OBJECTLIST), limits.getEndItem(Definitions.ELEMENT_MEDIA_OBJECTLIST), response.getResults().getNumFound());<a name="line.683"></a>
<span class="sourceLineNo">684</span>    }<a name="line.684"></a>
<span class="sourceLineNo">685</span>    <a name="line.685"></a>
<span class="sourceLineNo">686</span>    MediaObjectList voList = MediaObjectList.getMediaObjectList(mediaObjects, info);<a name="line.686"></a>
<span class="sourceLineNo">687</span>    _keywordsDAO.assignFriendlyKeywords(voList);<a name="line.687"></a>
<span class="sourceLineNo">688</span>    return voList;<a name="line.688"></a>
<span class="sourceLineNo">689</span>  }<a name="line.689"></a>
<span class="sourceLineNo">690</span>  <a name="line.690"></a>
<span class="sourceLineNo">691</span>  /**<a name="line.691"></a>
<span class="sourceLineNo">692</span>   * helper method for processing the data groups and setting filters for the query builder.<a name="line.692"></a>
<span class="sourceLineNo">693</span>   * <a name="line.693"></a>
<span class="sourceLineNo">694</span>   * @param dataGroups For applicable values see {@link service.tut.pori.contentanalysis.MediaObject.MediaObjectType#fromDataGroups(DataGroups)}.<a name="line.694"></a>
<span class="sourceLineNo">695</span>   * @param solr<a name="line.695"></a>
<span class="sourceLineNo">696</span>   * @return true if the data groups can returned results.<a name="line.696"></a>
<span class="sourceLineNo">697</span>   */<a name="line.697"></a>
<span class="sourceLineNo">698</span>  private boolean processDataGroups(DataGroups dataGroups, SolrQueryBuilder solr){<a name="line.698"></a>
<span class="sourceLineNo">699</span>    if(!DataGroups.hasDataGroup(DataGroups.DATA_GROUP_ALL, dataGroups, Definitions.ELEMENT_MEDIA_OBJECTLIST)){ // do not care about filters if ALL is present<a name="line.699"></a>
<span class="sourceLineNo">700</span>      boolean onlyBasic = DataGroups.hasDataGroup(DataGroups.DATA_GROUP_BASIC, dataGroups, Definitions.ELEMENT_MEDIA_OBJECTLIST);<a name="line.700"></a>
<span class="sourceLineNo">701</span>      <a name="line.701"></a>
<span class="sourceLineNo">702</span>      EnumSet&lt;ConfirmationStatus&gt; statuses = ConfirmationStatus.fromDataGroups(dataGroups);<a name="line.702"></a>
<span class="sourceLineNo">703</span>      if(statuses == null){<a name="line.703"></a>
<span class="sourceLineNo">704</span>        LOGGER.debug("No "+ConfirmationStatus.class.toString()+" filter, using defaults.");<a name="line.704"></a>
<span class="sourceLineNo">705</span>        solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_STATUS, DEFAULT_CONFIRMATION_STATUS_LIST));<a name="line.705"></a>
<span class="sourceLineNo">706</span>      }else{<a name="line.706"></a>
<span class="sourceLineNo">707</span>        onlyBasic = false;<a name="line.707"></a>
<span class="sourceLineNo">708</span>        solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_STATUS, ConfirmationStatus.toIntArray(statuses)));<a name="line.708"></a>
<span class="sourceLineNo">709</span>      }<a name="line.709"></a>
<span class="sourceLineNo">710</span>    <a name="line.710"></a>
<span class="sourceLineNo">711</span>      EnumSet&lt;MediaObjectType&gt; types = MediaObjectType.fromDataGroups(dataGroups);<a name="line.711"></a>
<span class="sourceLineNo">712</span>      if(types != null){<a name="line.712"></a>
<span class="sourceLineNo">713</span>        onlyBasic = false;<a name="line.713"></a>
<span class="sourceLineNo">714</span>        solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_MEDIA_OBJECT_TYPE, MediaObjectType.toIntArray(types)));<a name="line.714"></a>
<span class="sourceLineNo">715</span>      }<a name="line.715"></a>
<span class="sourceLineNo">716</span>      <a name="line.716"></a>
<span class="sourceLineNo">717</span>      if(DataGroups.hasDataGroup(Definitions.DATA_GROUP_TIMECODES, dataGroups, Definitions.ELEMENT_MEDIA_OBJECTLIST)){<a name="line.717"></a>
<span class="sourceLineNo">718</span>        onlyBasic = false;<a name="line.718"></a>
<span class="sourceLineNo">719</span>        solr.addFields(FIELDS_DATA_GROUP_TIMECODES);<a name="line.719"></a>
<span class="sourceLineNo">720</span>      }<a name="line.720"></a>
<span class="sourceLineNo">721</span>      <a name="line.721"></a>
<span class="sourceLineNo">722</span>      if(onlyBasic){<a name="line.722"></a>
<span class="sourceLineNo">723</span>        LOGGER.debug("Data group "+DataGroups.DATA_GROUP_BASIC+" given without other media object related data groups, no results can be found.");<a name="line.723"></a>
<span class="sourceLineNo">724</span>        return false;<a name="line.724"></a>
<span class="sourceLineNo">725</span>      }<a name="line.725"></a>
<span class="sourceLineNo">726</span>      <a name="line.726"></a>
<span class="sourceLineNo">727</span>      solr.addFields(FIELDS_DATA_GROUP_DEFAULTS);<a name="line.727"></a>
<span class="sourceLineNo">728</span>    }<a name="line.728"></a>
<span class="sourceLineNo">729</span>    return true;<a name="line.729"></a>
<span class="sourceLineNo">730</span>  }<a name="line.730"></a>
<span class="sourceLineNo">731</span>  <a name="line.731"></a>
<span class="sourceLineNo">732</span>  /**<a name="line.732"></a>
<span class="sourceLineNo">733</span>   * Suggestion/Autocomplete from Solr<a name="line.733"></a>
<span class="sourceLineNo">734</span>   * @param authenticatedUser <a name="line.734"></a>
<span class="sourceLineNo">735</span>   * @param dataGroups filters based on MediaObjectType. For applicable values see {@link service.tut.pori.contentanalysis.MediaObject.MediaObjectType#fromDataGroups(DataGroups)}.<a name="line.735"></a>
<span class="sourceLineNo">736</span>   * @param limits <a name="line.736"></a>
<span class="sourceLineNo">737</span>   * @param query the term to be searched for.<a name="line.737"></a>
<span class="sourceLineNo">738</span>   * @return response<a name="line.738"></a>
<span class="sourceLineNo">739</span>   */<a name="line.739"></a>
<span class="sourceLineNo">740</span>  public QueryResponse getSuggestions(UserIdentity authenticatedUser, DataGroups dataGroups, Limits limits, String query) {<a name="line.740"></a>
<span class="sourceLineNo">741</span>    SolrQueryBuilder solr = new SolrQueryBuilder();<a name="line.741"></a>
<span class="sourceLineNo">742</span>    <a name="line.742"></a>
<span class="sourceLineNo">743</span>    //set visibility restrictions<a name="line.743"></a>
<span class="sourceLineNo">744</span>    if(!UserIdentity.isValid(authenticatedUser)){<a name="line.744"></a>
<span class="sourceLineNo">745</span>      LOGGER.debug("Invalid authenticated user, limiting search to public content.");<a name="line.745"></a>
<span class="sourceLineNo">746</span>      solr.addCustomFilter(new AndQueryFilter(Definitions.SOLR_FIELD_VISIBILITY, Visibility.PUBLIC.toInt()));<a name="line.746"></a>
<span class="sourceLineNo">747</span>    }else{<a name="line.747"></a>
<span class="sourceLineNo">748</span>      solr.addCustomFilter(new AndSubQueryFilter(new AbstractQueryFilter[]{new OrQueryFilter(Definitions.SOLR_FIELD_USER_ID, authenticatedUser.getUserId()), new OrQueryFilter(Definitions.SOLR_FIELD_VISIBILITY, Visibility.PUBLIC.toInt())}));<a name="line.748"></a>
<span class="sourceLineNo">749</span>    }<a name="line.749"></a>
<span class="sourceLineNo">750</span>    <a name="line.750"></a>
<span class="sourceLineNo">751</span>    processDataGroups(dataGroups, solr); //sets the query filter for MediaObjectType<a name="line.751"></a>
<span class="sourceLineNo">752</span>    solr.setQueryParameter(new QueryParameter(query));<a name="line.752"></a>
<span class="sourceLineNo">753</span>    solr.setLimits(limits);<a name="line.753"></a>
<span class="sourceLineNo">754</span>    <a name="line.754"></a>
<span class="sourceLineNo">755</span>    return getSolrTemplate(BEAN_ID_SOLR_SERVER).query(SolrQueryBuilder.setRequestHandler(solr.toSolrQuery(), SolrQueryBuilder.RequestHandlerType.SUGGEST));<a name="line.755"></a>
<span class="sourceLineNo">756</span>  }<a name="line.756"></a>
<span class="sourceLineNo">757</span>}<a name="line.757"></a>




























































</pre>
</div>
</body>
</html>
